<!doctype html>
<html>
  <head>
    <title>Form Validation Using defenders.js</title>
    <meta charset="utf-8" />
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="../defenders.browser.js"></script>
    <script src="js/io.browser.js"></script>
    <script src="js/states.browser.js"></script>
    <script src="js/eithers.browser.js"></script>
    <script src="js/combinators.browser.js"></script>
    <script>
      function event(element, name, callback) {
          if(element.addEventListener) {
              element.addEventListener(name, callback, false);
          } else {
              element.attachEvent('on' + name, callback);
          }
      }

      event(window, 'load', function() {
          "use strict";

          var defender = defenders.defender,
              fortune = defenders.fortune,
              guardian = defenders.guardian,
              soothsayer = defenders.soothsayer,

              runes = defenders.runes,

              anythingBut = runes.anythingBut,
              range = runes.range,
              then = runes.then,

              Left = Eithers.Left,
              Right = Eithers.Right,

              identity = combinators.identity,
              compose = combinators.compose,
              constant = combinators.constant,

              pattern = IO(function() {
                    return '##-##-##';
              }),

              sayer = soothsayer({
                      '#': range(0, 9),
                      '-': then('-')
                  })(pattern),

              defend = defender(sayer),
              guard = guardian(/^\s/),

              readSortCode = readTextField('sort-code'),
              readRestrictedSortCode = readTextField('restrict-sort-code'),

              readRestrictedSortCodeSelection = readTextFieldSelection('restrict-sort-code');

          function element(id) {
              return document.getElementById(id);
          }

          function readTextField(id) {
              return function() {
                  return IO(function() {
                      return element(id).value;
                  });
              };
          }

          function readTextFieldSelection(id) {
              return function() {
                  return IO(function() {
                      var a = element(id);
                      return [a.selectionStart, a.selectionEnd];
                  });
              };
          }

          function show(x) {
              return 'Sort Code : ' + x;
          }

          function error(x) {
              return 'Error at ' + x._3 + ' with possible character `' + x._1 + '`';
          }

          function output(a) {
              return IO(function(b) {
                  /* This needs to be better */
                  a.fold(
                      function(b) {
                          var errors = b.fold(
                                  identity,
                                  identity
                              ),
                              html = '', i;
                          for(i = 0; i < errors.length; i++) {
                              html += '<li>' + error(errors[i]) + '</li>';
                          }
                          element('output').innerHTML = '<ul>' + html + '</ul>';
                          element('output').className = 'alert alert-danger';
                      },
                      function(b) {
                          return b.fold(
                              function(a) {
                                  element('output').innerHTML = '';
                                  element('output').className = '';
                              },
                              function(value) {
                                  element('output').innerHTML = show(value);
                                  element('output').className = 'alert alert-success';        
                              }
                          );
                      }
                  );
              });
          }

          function onKeyDown(value, selection) {
              var bouncer = function(prediction) {
                      var io = IO(constant(prediction));
                      return defend(guard(io));
                  },
                  preventDefault = function(event) {
                      var possibleCtrlCodes = [9, 13, 27, 33, 34, 35, 36, 45];

                      return function(response) {
                          return IO(function() {
                              response.fold(
                                  function() {
                                      if (possibleCtrlCodes.indexOf(event.keyCode) < 0) {
                                          event.preventDefault();
                                      }
                                  },
                                  identity
                              );
                              return response;
                          });
                      };
                  },
                  fromEvent = function(e) {
                      var fromUnicode = function(unicode) {
                              return String.fromCharCode(parseInt(unicode.slice(1), 16));
                          },
                          code = e.keyCode,
                          unicode = fromUnicode(e.keyIdentifier),

                          possibleDeleteCodes = [8, 46],
                          possibleArrowCodes = [37, 38, 39, 40],
                          possibleModifierCodes = [16, 17, 18, 20];

                      return IO(function() {
                          if (possibleDeleteCodes.indexOf(code) >= 0) {
                              return Left(code === 8 ? Left(code) : Right(code));
                          } else if(  possibleArrowCodes.indexOf(code) >= 0 || 
                                      possibleModifierCodes.indexOf(code) >= 0) {
                              return Right(Left(code));
                          }
                          return Right(Right(unicode));
                      });
                  };
              return function(e) {
                  var M = State.StateT(IO),

                      program =
                          M.lift(fortune(value)(fromEvent(e), selection))
                          .chain(compose(M.modify)(constant))
                          .chain(constant(M.get))
                          .chain(compose(M.lift)(bouncer))
                          .chain(compose(M.modify)(constant))
                          .chain(constant(M.get))
                          .chain(compose(M.lift)(preventDefault(e)))
                          .chain(compose(M.lift)(output));
                  
                  program.exec('').unsafePerform();
              };
          }

          function onKeyUp(io) {
              return function() {
                  var M = State.StateT(IO),

                      program =
                          M.lift(defend(guard(io)))
                          .chain(compose(M.modify)(constant))
                          .chain(constant(M.get))
                          .chain(compose(M.lift)(output));

                  program.exec('').unsafePerform();
              };
          }

          event(
              element('sort-code'), 
              'keyup', 
              onKeyUp(readSortCode())
          );

          event(
              element('restrict-sort-code'), 
              'keydown', 
              onKeyDown(
                  readRestrictedSortCode(),
                  readRestrictedSortCodeSelection()
              )
          );

          function create() {
              var M = State.StateT(IO),
                  div = function() {
                      return IO(function() {
                          return '<div><input type="text"/></div>';
                      });
                  },
                  span = function() {
                      return IO(function() {
                          return '<span>-</span>';
                      });
                  },

                  extract = function(a) {
                      return function() {
                          return a.map(function(b) {
                              return b.unsafePerform();
                          });
                      };
                  },

                  foldLeft = function(b, a, f) {
                      var v = a,
                          i;
                      for(i = 0; i<b.length; i++) {
                          v = f(v, b[i]);
                      }
                      return v;
                  },

                  filter = function(a, f) {
                      var accum = [],
                          i;
                      for(i = 0; i<a.length; i++) {
                          if(f(a[i])) {
                              accum.push(a[i]);
                          }
                      }
                      return accum;
                  },

                  liftedFoldLeft = function(a, f) {
                      return function(b) {
                          return constant(foldLeft(b, a, f));
                      };
                  },

                  merge = function(a, b) {
                      if(a[a.length - 1] !== b) {
                          a.push(b);
                      }
                      return a;
                  },

                  output = function(a) {
                      return IO(function() {
                          var x = element('separated-sort-code'),
                              y = a.map(function(y) {
                                  x.innerHTML += y;
                              }),
                              b = x.getElementsByTagName('input'),
                              c = [].slice.call(b),
                              xx = 0,
                              d = c.map(function(x) {
                                  return x.setAttribute('index', xx++);
                              });
                      });
                  },

                  sayer = soothsayer({
                          '#': div(),
                          '-': span()
                      })(pattern),

                  program =
                      M.lift(sayer)
                      .chain(compose(M.modify)(extract))
                      .chain(constant(M.get))
                      .chain(compose(M.modify)(liftedFoldLeft([], merge)))
                      .chain(constant(M.get))
                      .chain(compose(M.lift)(output));

              program.exec('').unsafePerform();

              event(
                  element('separated-sort-code'), 
                  'keydown', 
                  onKeyDown(
                      function() {
                          return IO(function() {
                              var a = element('separated-sort-code'),
                                  b = a.getElementsByTagName('input'),
                                  c = [].slice.call(b),
                                  d = c.map(function(x) {
                                      return x.value;
                                  }),
                                  e = filter(d, function(x) {
                                      return x !== '';
                                  }),
                                  f = foldLeft(e, '', function(a, b) {
                                      if (a === '') return b;
                                      return a + '-' + b;
                                  });

                              return f.length === 2 || f.length === 5 ? f + '-' : f;
                          });
                      }(),
                      function() {
                          return IO(function() {
                              var a = document.activeElement,
                                  b = a.getAttribute('index'),
                                  c = parseInt(b, 10);
                              
                              return [(c * 3) + a.selectionStart, a.selectionEnd];
                          });
                      }()
                  )
              );
          }
          create();
      });
    </script>
    <style type="text/css">
      #separated-sort-code div, span {
          float: left;
          display: inline;
          margin-right: 5px;
      }
      #separated-sort-code input {
          width: 40px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="jumbotron">
          <h1><a href="https://github.com/SimonRichardson/defender">defenders.js</a></h1>
          <p>Defending inputs across the land.</p>
          <hr/>
          <p><a href="#learn-more" class="btn btn-success btn-lg" role="button">Learn more</a></p>
      </div>
      <form>
      <fieldset>
        <dl class="panel panel-primary">
          <dt class="panel-heading">
              <h3 class="panel-title">Free field</h3>
          </dt>
          <dd class="panel-body">
            <label for="sort-code">Sortcode</label> <input id="sort-code" type="text" />
          </dd>
        </dl>
        <dl class="panel panel-primary">
          <dt class="panel-heading">
              <h3 class="panel-title">Restricted field</h3>
          </dt>
          <dd class="panel-body">
            <label for="restrict-sort-code">Sortcode</label> <input id="restrict-sort-code" type="text" />
          </dd>
        </dl>
        <dl class="panel panel-primary">
          <dt class="panel-heading">
              <h3 class="panel-title">Separated field</h3>
          </dt>
          <dd class="panel-body">
            <label for="separated-sort-code">Sortcode</label> <div id="separated-sort-code"></div>
          </dd>
        </dl>
      </fieldset>
    </form>
    <div id="output"></div>
    <a id="learn-more"></a>
    <div class="well well-lg">
      <h3>Introduction to the defenders</h2>
      <div class="panel-body">
        The defender library is made of a series of modules:
        <hr />
        <ul>
          <li>Defender</li>
          <li>Fortune teller</li>
          <li>Guardian</li>
          <li>Soothsayer - with runes</li>
        </ul>
      </div>
    </div>
  </body>
</html>
