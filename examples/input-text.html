<!doctype html>
<html>
  <head>
    <title>Form Validation Using defenders.js</title>
    <meta charset="utf-8" />
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="../defenders.browser.js"></script>
    <script src="js/io.browser.js"></script>
    <script src="js/states.browser.js"></script>
    <script src="js/eithers.browser.js"></script>
    <script src="js/options.browser.js"></script>
    <script src="js/combinators.browser.js"></script>
    <script>
      function event(element, name, callback) {
          if(element.addEventListener) {
              element.addEventListener(name, callback, false);
          } else {
              element.attachEvent('on' + name, callback);
          }
      }

      event(window, 'load', function() {
          "use strict";

          var defender = defenders.defender,
              fortune = defenders.fortune,
              guardian = defenders.guardian,
              soothsayer = defenders.soothsayer,

              runes = defenders.runes,

              anythingBut = runes.anythingBut,
              range = runes.range,
              then = runes.then,

              Some = Options.Some,
              None = Options.None,

              Left = Eithers.Left,
              Right = Eithers.Right,

              identity = combinators.identity,
              compose = combinators.compose,
              constant = combinators.constant,

              sayer = soothsayer({
                      '#': range(0, 9),
                      '-': then('-')
                  })('##-##-##'),

              defend = defender(sayer),
              guard = guardian(/^\s/),

              readSortCode = readTextField('sort-code'),
              readRestrictedSortCode = readTextField('restrict-sort-code'),

              readRestrictedSortCodeSelection = readTextFieldSelection('restrict-sort-code');

          function element(id) {
              return document.getElementById(id);
          }

          function readTextField(id) {
              return function() {
                  return IO(function() {
                      return element(id).value;
                  });
              };
          }

          function readTextFieldSelection(id) {
              return function() {
                  return IO(function() {
                      var a = element(id);
                      return [a.selectionStart, a.selectionEnd];
                  });
              };
          }

          function show(x) {
              return 'Sort Code : ' + x;
          }

          function error(x) {
              return 'Error at ' + x._3 + ' with possible character `' + x._1 + '`';
          }

          function output(a) {
              return IO(function(b) {
                  /* This needs to be better */
                  a.fold(
                      function(b) {
                          var errors = b.fold(
                                  identity,
                                  identity
                              ),
                              html = '', i;
                          for(i = 0; i < errors.length; i++) {
                              html += '<li>' + error(errors[i]) + '</li>';
                          }
                          element('output').innerHTML = '<ul>' + html + '</ul>';
                          element('output').className = 'alert alert-error';
                      },
                      function(b) {
                          return b.fold(
                              function(a) {
                                  element('output').innerHTML = '';
                                  element('output').className = 'alert';
                              },
                              function(value) {
                                  element('output').innerHTML = show(value);
                                  element('output').className = 'alert alert-success';        
                              }
                          );
                      }
                  );
              });
          }

          function onKeyDown(value, selection) {
              var bouncer = function(prediction) {
                      var io = IO(constant(prediction));
                      return defend(guard(io));
                  },
                  preventDefault = function(event) {
                      var possibleCtrlCodes = [9, 13, 16, 17, 18, 19, 20, 27, 33, 34, 35, 36, 37, 38, 39, 40, 45];

                      return function(response) {
                          return IO(function() {
                              response.fold(
                                  function() {
                                      if (possibleCtrlCodes.indexOf(event.keyCode) < 0) {
                                          event.preventDefault();
                                      }
                                  },
                                  identity
                              );
                              return response;
                          });
                      };
                  },
                  fromEvent = function(e) {
                      var fromUnicode = function(unicode) {
                              return String.fromCharCode(parseInt(unicode.slice(1), 16));
                          },
                          code = e.keyCode,
                          unicode = fromUnicode(e.keyIdentifier),

                          possibleDeleteCodes = [8, 46],
                          possibleArrowCodes = [37, 38, 39, 40];

                      return IO(function() {
                          if (possibleDeleteCodes.indexOf(code) >= 0) {
                              return Left(code === 8 ? Left(code) : Right(code));
                          } else if(possibleArrowCodes.indexOf(code) >= 0) {
                              return Right(Left(code));
                          }
                          return Right(Right(unicode));
                      });
                  };
              return function(e) {
                  var M = State.StateT(IO),

                      program =
                          M.lift(fortune(value)(fromEvent(e), selection))
                          .chain(compose(M.modify)(constant))
                          .chain(constant(M.get))
                          .chain(compose(M.lift)(bouncer))
                          .chain(compose(M.modify)(constant))
                          .chain(constant(M.get))
                          .chain(compose(M.lift)(preventDefault(e)))
                          .chain(compose(M.lift)(output));
                  
                  program.exec('').unsafePerform();
              };
          }

          function onKeyUp(io) {
              return function() {
                  var M = State.StateT(IO),

                      program =
                          M.lift(defend(guard(io)))
                          .chain(compose(M.modify)(constant))
                          .chain(constant(M.get))
                          .chain(compose(M.lift)(output));

                  program.exec('').unsafePerform();
              };
          }

          event(
              element('sort-code'), 
              'keyup', 
              onKeyUp(readSortCode())
          );

          event(
              element('restrict-sort-code'), 
              'keydown', 
              onKeyDown(
                  readRestrictedSortCode(),
                  readRestrictedSortCodeSelection()
              )
          );
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="span6 offset3">
          <h1>Form Validation Using defenders.js</h1>
          <form>
            <fieldset>
              <legend>Free field</legend>
              <label for="sort-code">Sortcode</label> <input id="sort-code" type="text" />
              <legend>Restricted field</legend>
              <label for="restrict-sort-code">Sortcode</label> <input id="restrict-sort-code" type="text" />
            </fieldset>
          </form>
          <div class="alert" id="output"></div>
        </div>
      </div>
    </div>
  </body>
</html>
