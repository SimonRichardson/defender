<!doctype html>
<html>
  <head>
    <title>Form Validation Using defenders.js</title>
    <meta charset="utf-8" />
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="../defenders.browser.js"></script>
    <script src="js/io.browser.js"></script>
    <script src="js/states.browser.js"></script>
    <script src="js/combinators.browser.js"></script>
    <script>
      function event(element, name, callback) {
          if(element.addEventListener) {
              element.addEventListener(name, callback, false);
          } else {
              element.attachEvent('on' + name, callback);
          }
      }

      event(window, 'load', function() {
          "use strict";

          var defender = defenders.defender,
              guardian = defenders.guardian,
              soothsayer = defenders.soothsayer,

              runes = defenders.runes,

              anythingBut = runes.anythingBut,
              range = runes.range,
              then = runes.then,

              identity = combinators.identity,
              compose = combinators.compose,
              constant = combinators.constant,

              sayer = soothsayer({
                      '#': range(0, 9),
                      '-': then('-')
                  })('##-##-##'),

              defend = defender(sayer),
              guard = guardian(/^\s/),

              readSortCode = readTextField('sort-code'),
              readRestrictedSortCode = readTextField('restrict-sort-code'),

              readRestrictedSortCodeSelection = readTextFieldSelection('restrict-sort-code');

          function dimap(a, b) {
              return function(c) {
                  return compose(compose(b)(c))(a);
              };
          }

          function split(a) {
              return function(b) {
                  return [b[0].split(a), b[1]];
              }
          }

          function join(a) {
              return function(b) {
                  return [b[0].join(a), b[1]];
              };
          }

          function replace(x) {
              return function(b) {
                  var values = b[0],
                      selection = b[1],
                      start = selection[0],
                      end = selection[1] - start;
                  values.splice(start, end, x);
                  return b;
              };
          }

          function element(id) {
              return document.getElementById(id);
          }

          function readTextField(id) {
              return function() {
                  return IO(function() {
                      return element(id).value;
                  });
              };
          }

          function readTextFieldSelection(id) {
              return function() {
                  return IO(function() {
                      var a = element(id);
                      return [a.selectionStart, a.selectionEnd];
                  });
              };
          }

          function show(x) {
              return 'Sort Code : ' + x;
          }

          function error(x) {
              return 'Error at ' + x._3 + ' with possible character `' + x._1 + '`';
          }

          function output(a) {
              // FIXME: Move this into a IO process!
              a.fold(
                  function(b) {
                      var errors = b.fold(
                              identity,
                              identity
                          ),
                          html = '', i;
                      for(i = 0; i < errors.length; i++) {
                          html += '<li>' + error(errors[i]) + '</li>';
                      }
                      element('output').innerHTML = '<ul>' + html + '</ul>';
                      element('output').className = 'alert alert-error';
                  },
                  function(b) {
                      return b.fold(
                          function(a) {
                              element('output').innerHTML = '';
                              element('output').className = 'alert';
                          },
                          function(value) {
                              element('output').innerHTML = show(value);
                              element('output').className = 'alert alert-success';        
                          }
                      );
                  }
              );
          }

          function onKeyDown(value, selection) {
              var inject = function(code) {
                      var x = String.fromCharCode(code);
                      console.log(x, code);
                      return function(a) {
                          return function(b) {
                              var list = dimap(split(''), join(''));
                              return list(replace(x))(a);
                          };
                      };
                  },
                  together = function(a) {
                      return function(b) {
                          return [b, a];
                      };
                  },
                  extract = function(a) {
                      return function(b) {
                          return b[0];
                      }
                  };
              return function(e) {
                  var M = State.StateT(IO),

                      fortune =
                          M.lift(value)
                          .chain(compose(M.modify)(constant))
                          .chain(constant(M.lift(selection)))
                          .chain(compose(M.modify)(together))
                          .chain(constant(M.get))
                          .chain(compose(M.modify)(inject(e.keyCode)))
                          .chain(constant(M.get))
                          .chain(compose(M.modify)(extract))
                          .chain(constant(M.get)),

                      prediction = fortune.exec(''),
                      program = defend(guard(prediction)),
                      response = program.unsafePerform();

                  // FIXME : Move this into IO
                  response.fold(
                      function() {
                          e.preventDefault();
                          output(response);
                      },
                      identity
                  );
              };
          }

          function onKeyUp(io) {
              return function() {
                  var program = defend(guard(io));
                  output(program.unsafePerform());
              };
          }

          event(
              element('sort-code'), 
              'keyup', 
              onKeyUp(readSortCode())
          );

          event(
              element('restrict-sort-code'), 
              'keydown', 
              onKeyDown(
                  readRestrictedSortCode(),
                  readRestrictedSortCodeSelection()
              )
          );
          event(
              element('restrict-sort-code'), 
              'keyup', 
              onKeyUp(readRestrictedSortCode())
          );
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="span6 offset3">
          <h1>Form Validation Using defenders.js</h1>
          <form>
            <fieldset>
              <legend>Free field</legend>
              <label for="sort-code">Sortcode</label> <input id="sort-code" type="text" />
              <legend>Restricted field</legend>
              <label for="restrict-sort-code">Sortcode</label> <input id="restrict-sort-code" type="text" />
            </fieldset>
          </form>
          <div class="alert" id="output"></div>
        </div>
      </div>
    </div>
  </body>
</html>
